// The logger runs asynchronously. Example of using it for manual capture of data from a script
// running continuously and hook up a visibility-toggle button:
// (I put this in my main Mind Stone)

// var logger = import logger
//
// ?key=bumpRBegin // C to toggle console
//   logger.toggleVisibility()
// 
// ?key=backBegin
//   logger.log(foe)

var _log = [] // all the different logged elements.
  // only keeps the most recent 20 elements so that things don't get too crazy.
var maxHistory = 20
var active = 0
var _style = -2
var p_border // the panel with a VISIBLE border
var p // the panel that actually bounds the text
var emptyStyle = ui.AddStyle("#########")
var t // the text element of the console; I'm not certain but I think I need to remake it each time.

func init()
  p_border = ui.AddPanel()
  p_border.visible = true
  p_border.color = #red
  p_border.anchor = top_right
  p_border.dock = top_right
  p_border.y = 1
  p_border.w = 64
  p_border.h = 12
  p_border.style = _style
  p_border.clip = false

  p = ui.AddPanel()
  p_border.Add(p)
  p.visible = true
  p.y = -1
  p.w = p_border.w
  p.h = p_border.h-1
  p.style = emptyStyle
  p.clip = true
  t = ui.AddText("default")
  p.Add(t)
  recreateText()

func restyle()
  p.style++
  ?p.style > 8
    p.style = -8

func log(_str)
  // given a string, add it to the array, trim the array, then re-derive the contents of the console panel text.
  // "newest at the end" wasn't formatting right at all, so I'm putting the newest stuff at the TOP.
  var str = _str + "" // I don't trust incoming stuff to actually be a string
  // _log.Add(str)
  ?_log.Count()=0
    _log.Add(str) // You can't insert at 0 when an array is empty?
  :
    _log.Insert(0, str)
  ?_log.Count()>maxHistory // this is only safe because we only add one line at a time; otherwise I'd need a loop.
    _log.RemoveAt(maxHistory-1)
  >@_log.Count()@
  recreateText()

func recreateText()
  // Remove the existing text component from the panel and make a new one from scratch from the _log array.
  // I believe this is needed, otherwise it doesn't update.
  p.Remove(t)
  t = ui.AddText()
  t.text = string.Join("\n", _log)
  t.x = 1
  t.y = 1
  t.w = p.w-2 // you lose the border so the text needs to be a bit smaller than the panel
  t.h = p.h-2
  t.align = left
  t.dock = top_left
  t.anchor = top_left
  p.Add(t)

func toggleVisibility()
  ?p.visible = true
    p.visible = false
    p_border.visible = false
  :
    p.visible = true
    p_border.visible = true
